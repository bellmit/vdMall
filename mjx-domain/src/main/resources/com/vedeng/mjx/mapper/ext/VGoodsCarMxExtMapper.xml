<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vedeng.mjx.mapper.ext.VGoodsCarMxExtMapper">

    <resultMap id="BaseResultMap" type="com.vedeng.mjx.domain.VGoodsCarMx">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="CAR_MX_ID" jdbcType="INTEGER" property="carMxId" />
        <result column="SKU_NO" jdbcType="VARCHAR" property="skuNo" />
        <result column="CAR_ID" jdbcType="INTEGER" property="carId" />
        <result column="SALE_TOTAL" jdbcType="DECIMAL" property="saleTotal" />
        <result column="COUNT" jdbcType="INTEGER" property="count" />
        <result column="IS_COMMIT" jdbcType="CHAR" property="isCommit" />
        <result column="IS_DEFAULT" jdbcType="CHAR" property="isDefault" />
        <result column="CREATOR" jdbcType="INTEGER" property="creator" />
        <result column="ADD_TIME" jdbcType="TIMESTAMP" property="addTime" />
        <result column="UPDATER" jdbcType="INTEGER" property="updater" />
        <result column="MOD_TIME" jdbcType="TIMESTAMP" property="modTime" />
        <result column="IS_DEL" jdbcType="CHAR" property="isDel" />
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        CAR_MX_ID, SKU_NO, CAR_ID, SALE_TOTAL, COUNT, IS_COMMIT, IS_DEFAULT, CREATOR, ADD_TIME,
        UPDATER, MOD_TIME, IS_DEL
    </sql>

    <!--查询购物车中商品是否上下架-->
    <select id="queryGoodsCarInfo" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT
        IS_ON_SALE as isOnSale
        FROM
        V_SKU
        WHERE
        IS_DEL = '0'
        AND PLATFROM_ID= 1
        and	SKU_NO = #{skuNo}
    </select>

    <!--修改购物车中的isCommitStatus-->
    <update id="updateIsCommitStatus" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        update V_GOODS_CAR_MX set IS_COMMIT = '0' where IS_DEL = '0' and CAR_ID = #{carId} and IS_COMMIT = '1'

    </update>
    <!--查询购物车主表isClose-->
    <select id="queryIsCloseStatus" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="java.lang.String">
        select
            IS_CLOSE as isClose
        from V_GOODS_CAR
        where
        USER_ID = #{accountId}
    </select>

    <!--修改购物车主表isClose-->
    <update id="updateIsCloseStatus">
        update V_GOODS_CAR set IS_CLOSE = #{isClose} where CAR_ID = #{carId}
    </update>

    <!--查询购物车列表-->
    <select id="queryGoodsCarList" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        SELECT
            CAR_MX_ID as carMxId,
            SKU_NO as skuNo,
            CAR_ID as carId,
            SALE_TOTAL as saleTotal,
            COUNT as count,
            IS_DEFAULT as isDefault
        FROM
            V_GOODS_CAR_MX
        WHERE
            IS_DEL = '0'
        <choose>
            <when test="isCount != null and isCount == 2 ">
                and IS_COMMIT = '1'
            </when>
            <otherwise>
                and IS_COMMIT in('0','1')
            </otherwise>
        </choose>
            and CAR_ID = #{carId}
        ORDER BY ADD_TIME desc
    </select>
    <!--查询购物车列表主入口页-->
    <select id="queryGoodsCarMxList" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        SELECT
            vm.CAR_MX_ID AS carMxId,
            vm.SKU_NO AS skuNo,
            vm.CAR_ID AS carId,
            vm.SALE_TOTAL AS saleTotal,
            COUNT AS count,
            vm.IS_DEFAULT AS isDefault,
            vs.IS_ON_SALE AS isOnSale,
            vm.ADD_TIME AS addTime
        FROM
            V_GOODS_CAR_MX vm
        LEFT JOIN V_SKU vs ON vm.SKU_NO = vs.SKU_NO
        WHERE
              vm.IS_DEL = '0'
        AND vm.IS_COMMIT IN ('0','1')
        AND vs.PLATFROM_ID = 1
        AND vm.CAR_ID = #{carId}
    </select>
    <!--查询购物车列表提交订单页-->
    <select id="queryGoodsCarMxListCom" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        SELECT
            vm.CAR_MX_ID AS carMxId,
            vm.SKU_NO AS skuNo,
            vm.CAR_ID AS carId,
            vm.SALE_TOTAL AS saleTotal,
            COUNT AS count,
            vm.IS_DEFAULT AS isDefault,
            vs.IS_ON_SALE AS isOnSale,
            vm.ADD_TIME AS addTime
        FROM
            V_GOODS_CAR_MX vm
        LEFT JOIN V_SKU vs ON vm.SKU_NO = vs.SKU_NO
        WHERE
              vm.IS_DEL = '0'
        AND vm.IS_COMMIT IN ('0','1')
        AND vs.PLATFROM_ID = 1
        AND vm.IS_DEFAULT='1'
        AND vs.IS_ON_SALE=1
        AND vm.CAR_ID = #{carId}
    </select>



    <!--根据用户去查是否有购物车-->
    <select id="queryFirst" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="java.util.Map">
        SELECT
            CAR_ID as carId,
            IS_FIRST as isFirst
        FROM
            V_GOODS_CAR
        WHERE
            USER_ID = #{accountId}
    </select>

    <!--根据用户去查是否有购物车-->
    <select id="queryPreCommitGoodsMxs" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        SELECT CAR_MX_ID carMxId,SKU_NO skuNo,IS_DEL isDel FROM V_GOODS_CAR_MX
        WHERE CAR_MX_ID IN
        <foreach collection="carMxIdList" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!--修改购物车主表中的isFirst-->
    <update id="checkFirst" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        UPDATE V_GOODS_CAR
            SET IS_FIRST = '1', MOD_TIME = now()
        WHERE
            USER_ID = #{accountId}
    </update>

    <!--新增购物车主表信息-->
    <insert id="insertUserCar" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" useGeneratedKeys="true" keyProperty="carId">
        insert into V_GOODS_CAR (
            USER_ID,
            IS_CLOSE,
            IS_FIRST,
            CREATOR,
            ADD_TIME,
            IS_DEL
        )values(
            #{accountId},
            '0',
            '0',
            #{accountId},
            now(),
            '0'
        )
    </insert>

    <!--新增购物车明细-->
    <insert id="addGoodsIntoCar" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        insert into V_GOODS_CAR_MX(
        SKU_NO,
        CAR_ID,
        <if test="count!=null and count!=''">
            COUNT,
        </if>

        IS_COMMIT,
        IS_DEFAULT,
        CREATOR,
        ADD_TIME,
        IS_DEL
        )values(
        #{skuNo},
        #{carId},
        <if test="count!=null and count!=''">
            #{count},
        </if>

        '0',
        '1',
        #{accountId},
        now(),
        '0'
        )
    </insert>

    <!--新增购物车明细-->
    <insert id="addGoodsCarMxOnDupKeyUpdate" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
    INSERT INTO V_GOODS_CAR_MX(SKU_NO,
        CAR_ID,
        COUNT,
        IS_COMMIT,
        IS_DEFAULT,
        CREATOR,
        ADD_TIME,
        IS_DEL
        ) SELECT #{skuNo},
        #{carId},
        #{count},
        '0',
        '1',
        #{accountId},
        now(),
        '0' FROM DUAL WHERE NOT EXISTS(SELECT CAR_MX_ID
        FROM V_GOODS_CAR_MX WHERE SKU_NO = #{skuNo} AND CAR_ID= #{carId} AND IS_DEL='0')

    </insert>

    <!--检验是否超过99-->
    <select id="querySkuNoCount" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="java.lang.Integer">
        SELECT
            count(0)
        FROM
            V_GOODS_CAR_MX
        WHERE
            IS_DEL = '0'
        and CAR_ID = #{carId}
        and IS_COMMIT in('0','1')
    </select>
    <!--检验是是否删除过-->
    <select id="queryIsDel" parameterType="java.lang.Integer" resultType="java.lang.String">

       SELECT IS_DEL isDel FROM V_GOODS_CAR_MX WHERE CAR_MX_ID=#{carMxId}
    </select>

    <!--购物车预提交（修改状态）-->
    <update id="insertPrepareGoodsCar" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        <foreach collection="skuNoList" item="item" index="index" open="" close="" separator=";">
            update V_GOODS_CAR_MX
            <set>
                IS_COMMIT = '1',
                MOD_TIME = now()
            </set>
            where SKU_NO = #{item} and CAR_ID = #{carId} and IS_DEL = '0'
        </foreach>
    </update>

    <!--购物车预提交退出（修改状态）-->
    <update id="exitPreCommitGoodsCar" parameterType="java.lang.Integer">
            update V_GOODS_CAR_MX
            <set>
                IS_COMMIT = '0',
                MOD_TIME = now()
            </set>
            where CAR_MX_ID = #{carMxId}
    </update>

    <!--修改复选框-->
    <update id="updateGoodsDefault" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        <foreach collection="skuNoList" item="item" index="index" open="" close="" separator=";">
            update V_GOODS_CAR_MX
            <set>
                IS_DEFAULT = #{status},
                MOD_TIME = now()
            </set>
            where SKU_NO = #{item} and CAR_ID = #{carId} and IS_DEL = '0'
        </foreach>
    </update>
    <!--修改复选框-->
    <update id="updateGoodsIsChoosed" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
            update V_GOODS_CAR_MX
            <set>
                IS_DEFAULT = #{status},
                MOD_TIME = now()
            </set>
            where CAR_MX_ID = #{carMxId}
    </update>
    <update id="updateGoodsIsChoosedAll" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
            update V_GOODS_CAR_MX
            <set>
                IS_DEFAULT = #{status},
                MOD_TIME = now()
            </set>
            where CAR_ID = #{carId}
            AND IS_DEL='0'
    </update>

    <!--修改数量-->
    <update id="updateGoodsCount" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        update V_GOODS_CAR_MX
        <set>
            COUNT = #{count},
            MOD_TIME = now()
        </set>
        where
            IS_DEL = '0'
            and SKU_NO = #{skuNo}
            and CAR_ID = #{carId}
    </update>


    <!--修改数量-->
    <update id="updateGoodsMxCount" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        update V_GOODS_CAR_MX
        <set>
            COUNT = #{count},
            MOD_TIME = now()
        </set>
        where
        CAR_MX_ID = #{carMxId}
    </update>
    <update id="softDeleteGoodsCarMx" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        update V_GOODS_CAR_MX
        IS_DEL = '1'
        where
        CAR_MX_ID = #{carMxId}
    </update>

    <!--删除购物车-->
    <update id="deleteGoodsCar" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        <foreach collection="skuNoList" item="item" index="index" open="" close="" separator=";">
            update V_GOODS_CAR_MX
            <set>
                IS_DEL = '1',
                MOD_TIME = now()
            </set>
            where SKU_NO = #{item} and CAR_ID = #{carId} and IS_DEL = '0'
        </foreach>
    </update>
    <!--删除购物车-->
    <update id="deleteGoodsCarMxs" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        update V_GOODS_CAR_MX
            <set>
                IS_DEL = '1',
                MOD_TIME = now()
            </set>
            where CAR_MX_ID IN
        <foreach collection="carMxIdList" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>

    </update>
    <!--检查是否存在过skuNo-->
    <select id="queryExisetSkuNo" parameterType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx" resultType="java.util.Map">
        SELECT
            COUNT as count
        FROM
            V_GOODS_CAR_MX
        WHERE IS_DEL = '0'
            and SKU_NO =#{skuNo}
            and CAR_ID =#{carId}
            and IS_COMMIT in ('0','1') for update
    </select>
    <!--检查是否存在过skuNo-->
    <select id="existsSkuNoInNoCommit" parameterType="java.lang.String" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
    SELECT
    CAR_MX_ID as carMxId,COUNT as count FROM  V_GOODS_CAR_MX WHERE SKU_NO=#{skuNo} WHERE
            IS_COMMIT='0'
            and IS_DEL = '0'
    </select>
    <select id="queryByCarMxId" parameterType="java.lang.Integer" resultType="com.vedeng.mjx.domain.ext.VGoodsCarExtMx">
        SELECT
            SKU_NO as skuNo,
            COUNT as count
        FROM
            V_GOODS_CAR_MX
        WHERE
           CAR_MX_ID=#{carMxId}
    </select>

    <select id="selectVGoodsCarMxList" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from V_GOODS_CAR_MX
        where CAR_MX_ID in(
        <foreach collection="list" separator="," item="index">
            #{index}
        </foreach>
        )
        AND IS_DEL = 0
    </select>

    <update id="updateGoodsCarList">
        update V_GOODS_CAR_MX
        set IS_COMMIT = 2,IS_DEL = 1
        where CAR_MX_ID in(
        <foreach collection="list" separator="," item="index">
            #{index.carMxId}
        </foreach>
        )
    </update>

    <select id="getGoodCarCount" parameterType="java.lang.Integer"
            resultMap="BaseResultMap">
        SELECT
	  CAR_MX_ID,SKU_NO,CAR_ID FROM V_GOODS_CAR_MX
        WHERE CAR_ID = (
		SELECT
			CAR_ID
		FROM
			V_GOODS_CAR
		WHERE
			USER_ID = #{accountId})
		AND IS_DEL = '0'
		AND  IS_COMMIT in('0','1')

    </select>
    
</mapper>